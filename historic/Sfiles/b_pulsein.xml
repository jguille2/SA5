<blocks app="Snap4Arduino 1.0.6 beta http://s4a.cat/snap" version="1"><block-definition s="$robot pulseIn (µs) pin %&apos;pin&apos; | %&apos;stValue&apos; timeout: %&apos;timeout&apos; µs" type="reporter" category="arduino"><comment x="0" y="0" w="778" collapsed="false">Return a pulse (either HIGH or LOW) on a pin in microseconds.&#xD;&#xD;-Default timeout is 1 second (1000000 µs)&#xD;</comment><header></header><code></code><inputs><input type="%n"></input><input type="%txt" readonly="true">HIGH<options>HIGH
LOW</options></input><input type="%n"></input></inputs><script><block s="doRun"><block s="reportJSFunction"><list><l></l></list><l>board = this.arduino.board; //Definition should change according to the context&#xD;if (board.pins[2].supportedModes.indexOf(0x05) === -1) {&#xD;  throw new Error("Please upload SA5Firmata2.ino a higher version");&#xD;}</l></block><list></list></block><block s="doRun"><block s="reportJSFunction"><list><l>pin</l><l>stValue</l><l>timeout</l></list><l>board = this.arduino.board; //Definition should change according to the context&#xD;//Response definition&#xD;world.Arduino.firmata.SYSEX_RESPONSE[0xC8] = function(board) {&#xD;  var pulse = (board.currentBuffer[2] &amp; 0x7F) &lt;&lt; 25| (board.currentBuffer[3] &amp; 0x7F) &lt;&lt; 18 | (board.currentBuffer[4] &amp; 0x7F) &lt;&lt; 11 | (board.currentBuffer[5] &amp; 0x7F) &lt;&lt; 4 | (board.currentBuffer[6] &amp; 0x7F) &gt;&gt; 3;&#xD;  var pinResp = (board.currentBuffer[6] &amp; parseInt("0111",2)) &lt;&lt; 5 | (board.currentBuffer[7] &amp; parseInt("011111",2));&#xD;  board.emit("pulseIn-"+pinResp, pulse);&#xD;}&#xD;//Async reporting&#xD;report = this;&#xD;this.arduino["pulseIn-"+pin] = null;&#xD;//Launcher&#xD;value = 1;&#xD;if (stValue == "LOW") {value = 0;} //only explicit LOW return a low pulse &#xD;if (pin === undefined || pin &lt;= 1 || pin &gt; 255) {&#xD;  throw new Error("Required var pin (2-255)");&#xD;}&#xD;var timeout = timeout || 0; //undefined will be 0, and 0 causes Arduino&apos;s default (1s)&#xD;timeout = timeout &amp; 0xFFFFFFFF; //clamping value to 32 bits&#xD;board.once("pulseIn-"+pin, function(data){report.arduino["pulseIn-"+pin] = data;});&#xD;var data =[0xF0, //START_SYSEX&#xD;        		0xC8,  //PulseIn Command&#xD;        		(timeout &gt;&gt; 25) &amp; 0x7F,&#xD;        		(timeout &gt;&gt; 18) &amp; 0x7F,&#xD;        		(timeout &gt;&gt; 11) &amp; 0x7F,&#xD;      	  	(timeout &gt;&gt; 4) &amp; 0x7F,&#xD;      		  ((timeout &lt;&lt; 3) &amp; parseInt("01111000",2)) | ((value &lt;&lt; 2) &amp; parseInt("0100",2)) | ((pin &gt;&gt; 6) &amp; parseInt("011",2)),&#xD;      		  (pin &amp; parseInt("0111111",2)),&#xD;      		  0xF7  //END_SYSEX&#xD;];&#xD;board.transport.write(new Buffer(data)) ;</l></block><list><block var="pin"/><block var="stValue"/><block var="timeout"/></list></block><block s="doWaitUntil"><block s="evaluate"><block s="reportJSFunction"><list><l>pin</l></list><l>return (this.arduino["pulseIn-"+pin] != null);</l></block><list><block var="pin"/></list></block></block><block s="doReport"><block s="evaluate"><block s="reportJSFunction"><list><l>pin</l></list><l>return this.arduino["pulseIn-"+pin];</l></block><list><block var="pin"/></list></block></block></script></block-definition></blocks>