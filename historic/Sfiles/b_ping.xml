<blocks app="Snap4Arduino 1.0.6 beta http://s4a.cat/snap" version="1"><block-definition s="$robot ping (cm) Trig %&apos;pinSen&apos; Echo %&apos;pinRec&apos; pulse %&apos;time1&apos; %&apos;time2&apos; µs" type="reporter" category="arduino"><comment x="0" y="0" w="658" collapsed="false">Return distance (in cm) from a Ultrasonic sensor.&#xD;&#xD;-You must select the connection pins (trigger and echo).&#xD;-You can modify trigger pulse. By default it sends a 5 µs pulse after 2µs in low state.&#xD;-Distance calculation assumes the speed of sound is 343m/s (value in dry air at 20ºC)</comment><header></header><code></code><inputs><input type="%n">4</input><input type="%n">2</input><input type="%n">2</input><input type="%n">5</input></inputs><script><block s="doRun"><block s="reportJSFunction"><list><l></l></list><l>board = this.arduino.board; //Definition should change according to the context&#xD;if (board.pins[2].supportedModes.indexOf(0x05) === -1) {&#xD;  throw new Error("Please upload SA5Firmata2.ino a higher version");&#xD;}</l></block><list></list></block><block s="doRun"><block s="reportJSFunction"><list><l>pinRec</l><l>pinSen</l><l>time1</l><l>time2</l></list><l>board = this.arduino.board; //Definition should change according to the context&#xD;//Response definition&#xD;world.Arduino.firmata.SYSEX_RESPONSE[0xCA] = function(board) {&#xD;  var pulse = (board.currentBuffer[2] &amp; 0x7F) &lt;&lt; 9| (board.currentBuffer[3] &amp; 0x7F) &lt;&lt; 2 | (board.currentBuffer[4] &amp; parseInt("01100000",2)) &gt;&gt; 5;&#xD;  var pinResponse = (board.currentBuffer[4] &amp; parseInt("011111",2)) &lt;&lt; 3 | (board.currentBuffer[5] &amp; parseInt("0111",2));&#xD;  board.emit("ping-"+pinResponse, pulse);&#xD;}&#xD;//Async reporting&#xD;report = this;&#xD;this.arduino["ping-"+pinRec] = null;&#xD;//Launcher&#xD;if (pinSen === undefined || pinSen &lt;= 1 || pinSen &gt; 255 || pinRec === undefined || pinRec &lt;= 1 || pinRec &gt; 255) {&#xD;  throw new Error("Required vars pinSen and pinRec (2-255)");&#xD;}&#xD;board.once("ping-"+pinRec, function(data){report.arduino["ping-"+pinRec] = data;});&#xD;var data =[0xF0, //START_SYSEX&#xD;        		0xCA,  //Ping Command&#xD;        		(pinSen &gt;&gt; 1) &amp; 0x7F,&#xD;        		(pinSen &lt;&lt; 6) | (time1 &amp; parseInt("011111",2)),&#xD;        		(pinRec &gt;&gt; 1) &amp; 0x7F,&#xD;      		  (pinRec &lt;&lt; 6) | (time2 &amp; parseInt("011111",2)),&#xD;      		  0xF7  //END_SYSEX&#xD;];&#xD;board.transport.write(new Buffer(data));</l></block><list><block var="pinRec"/><block var="pinSen"/><block var="time1"/><block var="time2"/></list></block><block s="doWaitUntil"><block s="evaluate"><block s="reportJSFunction"><list><l>pinRec</l></list><l>return (this.arduino["ping-"+pinRec] != null);</l></block><list><block var="pinRec"/></list></block></block><block s="doReport"><block s="evaluate"><block s="reportJSFunction"><list><l>pinRec</l></list><l>var value = Math.round(this.arduino["ping-"+pinRec]/29.15/2);&#xD;if (value == 0) return 1000;&#xD;return value;</l></block><list><block var="pinRec"/></list></block></block></script></block-definition></blocks>